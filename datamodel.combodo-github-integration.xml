<?xml version="1.0" encoding="UTF-8"?>
<itop_design xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="3.1">
  <constants>
  </constants>
  <classes>

    /* VCS Connector *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="VCSConnector" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>vcs_connector</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <attributes>
            <attribute id="label"/>
          </attributes>
          <complementary_attributes>
            <attribute id="provider"/>
            <attribute id="owner"/>
            <attribute id="mode"/>
          </complementary_attributes>
        </naming>
        <display_template/>
        <style>
          <icon>assets/img/icons8-cloud-connection-code-fork.svg</icon>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- label -->
        <field id="label" xsi:type="AttributeString">
          <sql>label</sql>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- provider -->
        <field id="provider" xsi:type="AttributeEnum">
          <values>
            <value id="github">
              <code>github</code>
            </value>
          </values>
          <sql>provider</sql>
          <default_value>github</default_value>
          <is_null_allowed>false</is_null_allowed>
          <display_style>list</display_style>
        </field>
        <!-- owner -->
        <field id="owner" xsi:type="AttributeString">
          <sql>owner</sql>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- mode -->
        <field id="mode" xsi:type="AttributeEnum">
          <values>
            <value id="none">
              <code>none</code>
              <rank>1</rank>
            </value>
            <value id="personal">
              <code>personal</code>
              <rank>2</rank>
            </value>
            <value id="app">
              <code>app</code>
              <rank>3</rank>
            </value>
          </values>
          <sql>mode</sql>
          <default_value>none</default_value>
          <is_null_allowed>false</is_null_allowed>
          <sort_type>rank</sort_type>
          <display_style>list</display_style>
        </field>
        <!-- personal access token -->
        <field id="personal_access_token" xsi:type="AttributeString">
          <sql>personal_access_token</sql>
          <is_null_allowed>true</is_null_allowed>
          <dependencies>
            <attribute id="mode"/>
          </dependencies>
        </field>
        <!-- app id -->
        <field id="app_id" xsi:type="AttributeString">
          <sql>app_id</sql>
          <is_null_allowed>true</is_null_allowed>
          <dependencies>
            <attribute id="mode"/>
          </dependencies>
        </field>
        <!-- app private key -->
        <field id="app_private_key" xsi:type="AttributeLongText">
          <sql>app_private_key</sql>
          <is_null_allowed>true</is_null_allowed>
          <dependencies>
            <attribute id="mode"/>
          </dependencies>
          <has_blur>true</has_blur>
          <default_value><![CDATA[-----BEGIN RSA PRIVATE KEY-----
your private key goes here
-----END RSA PRIVATE KEY-----]]></default_value>
        </field>
        <!-- repositories -->
        <field id="repositories_list" xsi:type="AttributeLinkedSet">
        <linked_class>VCSRepository</linked_class>
        <ext_key_to_me>connector_id</ext_key_to_me>
        <edit_mode>actions</edit_mode>
        </field>
        </fields>
      <methods>
        <!-- GetInitialStateAttributeFlags -->
        <method id="GetInitialStateAttributeFlags">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
              public function GetInitialStateAttributeFlags($sAttCode, &$aReasons = array())
              {
                  $sMode = $this->Get('mode');
                  switch ($sAttCode) {
                      case 'provider':
                          $iFlag = OPT_ATT_READONLY;
                          break;
                      case 'personal_access_token':
                         $iFlag = ($sMode == 'personal') ? OPT_ATT_MANDATORY : 0;
                          break;
                      case 'app_id':
                      case 'app_private_key':
                          $iFlag = ($sMode == 'app') ? OPT_ATT_MANDATORY : 0;
                          break;
                      case 'app_id':
                          $iFlag = 0;
                          break;
                   }

                  return $iFlag | parent::GetInitialStateAttributeFlags($sAttCode, $aReasons);
              }
          ]]>
          </code>
        </method>
        <!-- GetAttributeFlags -->
        <method id="GetAttributeFlags">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
              public function GetAttributeFlags($sAttCode, &$aReasons = array(), $sTargetState = '')
              {
                  $sMode = $this->Get('mode');
                  switch ($sAttCode) {
                      case 'provider':
                          $iFlag = OPT_ATT_READONLY;
                          break;
                      case 'personal_access_token':
                         $iFlag = ($sMode == 'personal') ? OPT_ATT_MANDATORY : 0;
                          break;
                      case 'app_id':
                      case 'app_private_key':
                          $iFlag = ($sMode == 'app') ? OPT_ATT_MANDATORY : 0;
                          break;
                      case 'app_id':
                          $iFlag = 0;
                          break;
                  }

                  return $iFlag | parent::GetAttributeFlags($sAttCode, $aReasons, $sTargetState);
              }
            ]]>
          </code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="fieldset:Class:VCSConnector:connector">
              <rank>10</rank>
              <items>
                <item id="label">
                  <rank>10</rank>
                </item>
                <item id="provider">
                  <rank>20</rank>
                </item>
                <item id="owner">
                  <rank>30</rank>
                </item>
              </items>
            </item>
            <item id="fieldset:Class:VCSConnector:authentication">
              <rank>20</rank>
              <items>
                <item id="mode">
                  <rank>40</rank>
                </item>
                <item id="personal_access_token">
                  <rank>50</rank>
                </item>
                <item id="app_id">
                  <rank>60</rank>
                </item>
                <item id="app_private_key">
                  <rank>70</rank>
                </item>
              </items>
            </item>
            <item id="repositories_list">
              <rank>30</rank>
            </item>
          </items>
        </details>
        <default_search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
            <item id="owner">
              <rank>30</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
            <item id="owner">
              <rank>30</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="provider">
              <rank>20</rank>
            </item>
            <item id="owner">
              <rank>30</rank>
            </item>
            <item id="mode">
              <rank>40</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* VCS Repository *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="VCSRepository" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>vcs_repository</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <format>%1$s</format>
          <attributes>
            <attribute id="name"/>
          </attributes>
          <complementary_attributes>
            <attribute id="webhook_url"/>
          </complementary_attributes>
        </naming>
        <fields_semantic>
          <state_attribute>webhook_status</state_attribute>
        </fields_semantic>
        <display_template/>
        <style>
          <icon>assets/img/icons8-repository-code-fork.svg</icon>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- name -->
        <field id="name" xsi:type="AttributeString">
          <sql>name</sql>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- synchro_mode -->
        <field id="synchro_mode" xsi:type="AttributeEnum">
          <values>
            <value id="none">
              <code>none</code>
            </value>
            <value id="manual">
              <code>manual</code>
            </value>
            <value id="auto">
              <code>auto</code>
            </value>
          </values>
          <sql>synchro_mode</sql>
          <default_value>auto</default_value>
          <is_null_allowed>false</is_null_allowed>
          <display_style>radio_horizontal</display_style>
        </field>
        <!-- connector -->
        <field id="connector_id" xsi:type="AttributeExternalKey">
          <sql>connector_id</sql>
          <target_class>VCSConnector</target_class>
          <is_null_allowed>true</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <!-- connector_provider -->
        <field id="connector_provider" xsi:type="AttributeExternalField">
          <extkey_attcode>connector_id</extkey_attcode>
          <target_attcode>provider</target_attcode>
        </field>
        <!-- webhook_url -->
        <field id="webhook_url" xsi:type="AttributeString">
          <sql>webhook_url</sql>
          <is_null_allowed>true</is_null_allowed>
          <copy_link>true</copy_link>
        </field>
        <!-- secret -->
        <field id="secret" xsi:type="AttributeEncryptedString">
          <sql>secret</sql>
          <is_null_allowed>false</is_null_allowed>
          <has_blur>true</has_blur>
        </field>
        <!-- webhook status -->
        <field id="webhook_status" xsi:type="AttributeEnum">
          <values>
            <value id="unset">
              <code>unset</code>
            </value>
            <value id="error">
              <code>error</code>
              <style>
                <main_color>$ibo-lifecycle-failure-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-failure-state-secondary-color</complementary_color>
              </style>
            </value>
            <value id="unsynchronized">
              <code>unsynchronized</code>
              <style>
                <main_color>$ibo-lifecycle-failure-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-failure-state-secondary-color</complementary_color>
              </style>
            </value>
            <value id="active">
              <code>active</code>
              <style>
                <main_color>$ibo-lifecycle-success-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-success-state-secondary-color</complementary_color>
              </style>
            </value>
            <value id="inactive">
              <code>inactive</code>
              <style>
                <main_color>$ibo-lifecycle-frozen-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-frozen-state-secondary-color</complementary_color>
              </style>
            </value>
          </values>
          <sql>webhook_status</sql>
          <default_value>unsynchronized</default_value>
          <is_null_allowed>false</is_null_allowed>
          <display_style>list</display_style>
        </field>
        <!-- event count -->
        <field id="event_count" xsi:type="AttributeInteger">
          <sql>event_count</sql>
          <default_value>0</default_value>
          <is_null_allowed>false</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <!-- last event date -->
        <field id="last_event_date" xsi:type="AttributeDateTime">
          <sql>last_event_date</sql>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
        <!-- events log -->
        <field id="events_log" xsi:type="AttributeCaseLog">
          <sql>events_log</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <!-- github_webhook_configuration -->
        <field id="github_webhook_configuration" xsi:type="AttributeLongText">
          <sql>github_webhook_configuration</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <!-- contacts_list -->
        <field id="contacts_list" xsi:type="AttributeLinkedSetIndirect">
          <linked_class>lnkContactToVCSRepository</linked_class>
          <ext_key_to_me>vcsrepository_id</ext_key_to_me>
          <ext_key_to_remote>contact_id</ext_key_to_remote>
          <count_min>0</count_min>
          <count_max>0</count_max>
          <with_php_computation>false</with_php_computation>
          <duplicates/>
        </field>
        <!-- documents_list -->
        <field id="documents_list" xsi:type="AttributeLinkedSetIndirect">
          <linked_class>lnkDocumentToVCSRepository</linked_class>
          <ext_key_to_me>vcsrepository_id</ext_key_to_me>
          <ext_key_to_remote>document_id</ext_key_to_remote>
          <count_min>0</count_min>
          <count_max>0</count_max>
          <with_php_computation>true</with_php_computation>
          <duplicates/>
        </field>
        <!-- automations_list -->
        <field id="automations_list" xsi:type="AttributeLinkedSetIndirect">
          <linked_class>lnkVCSAutomationToVCSRepository</linked_class>
          <ext_key_to_me>repository_id</ext_key_to_me>
          <ext_key_to_remote>automation_id</ext_key_to_remote>
          <count_min>0</count_min>
          <count_max>0</count_max>
          <with_php_computation>true</with_php_computation>
          <duplicates/>
        </field>
        <!-- external_data -->
        <field id="external_data" xsi:type="AttributeLongText">
          <sql>external_data</sql>
          <is_null_allowed>true</is_null_allowed>
          <tracking_level>none</tracking_level>
        </field>
      </fields>
      <methods>
        <!-- PrefillCreationForm -->
        <method id="PrefillCreationForm">
          <static>false</static>
          <type>Overload-DBObject</type>
          <code><![CDATA[
    public function PrefillCreationForm(&$aContextParam)
    {
        $oGitHubManager = \Combodo\iTop\VCSManagement\Service\GitHubManager::GetInstance();
        $this->Set('secret', $oGitHubManager->GenerateSecret(15,15,5,7));
        parent::PrefillCreationForm($aContextParam);
    }
            ]]></code>
        </method>
        <!-- GetInitialStateAttributeFlags -->
        <method id="GetInitialStateAttributeFlags">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
              public function GetInitialStateAttributeFlags($sAttCode, &$aReasons = array())
              {
                  if (in_array($sAttCode, ['webhook_url', 'webhook_status', 'event_count', 'last_event_date', 'github_webhook_configuration'])) {
                      return OPT_ATT_HIDDEN;
                  }
                  return parent::GetInitialStateAttributeFlags($sAttCode, $aReasons);
              }
          ]]>
          </code>
        </method>
        <!-- GetAttributeFlags -->
        <method id="GetAttributeFlags">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
              public function GetAttributeFlags($sAttCode, &$aReasons = array(), $sTargetState = '')
              {
                  if($sAttCode === 'last_event_date' && $this->Get('event_count') == 0){
                      return OPT_ATT_HIDDEN;
                  }

                  if (in_array($sAttCode, ['webhook_url', 'webhook_status', 'event_count', 'last_event_date'])) {
                      return OPT_ATT_READONLY;
                  }

                  if($sAttCode === 'name' && $this->Get('webhook_status') !== 'error'){
                      return OPT_ATT_READONLY;
                  }

                  if($sAttCode === 'github_webhook_configuration' && utils::IsNullOrEmptyString($this->Get('github_webhook_configuration'))){
                      return OPT_ATT_HIDDEN;
                  }

                  return parent::GetAttributeFlags($sAttCode, $aReasons, $sTargetState);
              }
            ]]>
          </code>
        </method>
        <!-- DisplayBareRelations -->
        <method id="DisplayBareRelations">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
            public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
            {
                if(!$bEditMode){

                    // add css
                    $oPage->add_saas('env-' . utils::GetCurrentEnvironment() . '/combodo-github-integration/assets/css/global.scss');

                    // separator
                    $oPage->AddSubBlock(new \Combodo\iTop\Application\UI\Base\Component\Html\Html('<hr>'));

                    // repository information
                    $aExternalData = json_decode($this->Get('external_data'), true);
                    $oBlockRepositoryInfo = new \Combodo\iTop\Application\UI\Base\Layout\UIContentBlock('github_info');
                    $oBlockRepositoryInfo->AddCSSClass('combodo-github-integration--repository-info-container');
                    $sRenderedText = \Combodo\iTop\VCSManagement\Helper\ModuleHelper::RenderGitHubInfoTemplate($this, $aExternalData);
                    $oBlockRepositoryInfo->AddSubBlock(new \Combodo\iTop\Application\UI\Base\Component\Html\Html($sRenderedText));
                    $oPage->AddUiBlock($oBlockRepositoryInfo);
                }

                 parent::DisplayBareRelations($oPage, $bEditMode);
            }
            ]]>
          </code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="synchro_mode">
              <rank>20</rank>
            </item>
            <item id="webhook_status">
              <rank>30</rank>
            </item>
            <item id="connector_id">
              <rank>40</rank>
            </item>
            <item id="connector_provider">
              <rank>50</rank>
            </item>
            <item id="webhook_url">
              <rank>60</rank>
            </item>
            <item id="secret">
              <rank>70</rank>
            </item>
            <item id="event_count">
              <rank>80</rank>
            </item>
            <item id="last_event_date">
              <rank>90</rank>
            </item>
            <item id="contacts_list">
              <rank>100</rank>
            </item>
            <item id="documents_list">
              <rank>110</rank>
            </item>
            <item id="automations_list">
              <rank>120</rank>
            </item>
          </items>
        </details>
        <default_search>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="webhook_status">
              <rank>20</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="name">
              <rank>10</rank>
            </item>
            <item id="webhook_status">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="connector_id">
              <rank>10</rank>
            </item>
            <item id="webhook_status">
              <rank>20</rank>
            </item>
            <item id="last_event_date">
              <rank>30</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* Link Contact To VCS Repository *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="lnkContactToVCSRepository" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <is_link>1</is_link>
        <category>bizmodel</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>lnkcontacttovcsrepository</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <naming>
          <attributes>
            <attribute id="contact_name"/>
            <attribute id="vcsrepository_name"/>
          </attributes>
        </naming>
        <style>
          <icon/>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="contact_id"/>
            <attribute id="vcsrepository_name"/>
          </attributes>
        </reconciliation>
        <uniqueness_rules>
          <rule id="no_duplicate">
            <attributes>
              <attribute id="contact_id"/>
              <attribute id="vcsrepository_id"/>
            </attributes>
            <filter><![CDATA[]]></filter>
            <disabled>false</disabled>
            <is_blocking>true</is_blocking>
          </rule>
        </uniqueness_rules>
      </properties>
      <fields>
        <field id="contact_id" xsi:type="AttributeExternalKey">
          <sql>contact_id</sql>
          <target_class>Contact</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="contact_name" xsi:type="AttributeExternalField">
          <extkey_attcode>contact_id</extkey_attcode>
          <target_attcode>name</target_attcode>
        </field>
        <field id="vcsrepository_id" xsi:type="AttributeExternalKey">
          <sql>vcsrepository_id</sql>
          <target_class>VCSRepository</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="vcsrepository_name" xsi:type="AttributeExternalField">
          <extkey_attcode>vcsrepository_id</extkey_attcode>
          <target_attcode>name</target_attcode>
        </field>
      </fields>
      <methods/>
      <presentation>
        <details>
          <items>
            <item id="contact_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </details>
        <search>
          <items>
            <item id="contact_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="contact_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* Link Document To VCS Repository *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="lnkDocumentToVCSRepository" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <is_link>1</is_link>
        <category>bizmodel</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>lnkdocumenttovcsrepository</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <naming>
          <attributes>
            <attribute id="document_name"/>
            <attribute id="vcsrepository_name"/>
          </attributes>
        </naming>
        <style>
          <icon/>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="document_id"/>
            <attribute id="vcsrepository_id"/>
          </attributes>
        </reconciliation>
        <uniqueness_rules>
          <rule id="no_duplicate">
            <attributes>
              <attribute id="document_id"/>
              <attribute id="vcsrepository_id"/>
            </attributes>
            <filter><![CDATA[]]></filter>
            <disabled>false</disabled>
            <is_blocking>true</is_blocking>
          </rule>
        </uniqueness_rules>
      </properties>
      <fields>
        <field id="document_id" xsi:type="AttributeExternalKey">
          <sql>document_id</sql>
          <target_class>Document</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="document_name" xsi:type="AttributeExternalField">
          <extkey_attcode>document_id</extkey_attcode>
          <target_attcode>name</target_attcode>
        </field>
        <field id="vcsrepository_id" xsi:type="AttributeExternalKey">
          <sql>vcsrepository_id</sql>
          <target_class>VCSRepository</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="vcsrepository_name" xsi:type="AttributeExternalField">
          <extkey_attcode>vcsrepository_id</extkey_attcode>
          <target_attcode>name</target_attcode>
        </field>
      </fields>
      <methods/>
      <presentation>
        <details>
          <items>
            <item id="document_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </details>
        <search>
          <items>
            <item id="document_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="document_id">
              <rank>10</rank>
            </item>
            <item id="vcsrepository_id">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* Link VCS Repository To VCS Automation *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="lnkVCSAutomationToVCSRepository" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <is_link>1</is_link>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>lnkvcsautomationtovcsrepository</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <attributes>
            <attribute id="repository_name"/>
            <attribute id="automation_label"/>
          </attributes>
        </naming>
        <display_template/>
        <style>
          <icon>assets/img/icons8-cloud-connection-code-fork-automation.svg</icon>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="repository_id"/>
            <attribute id="automation_id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- repository -->
        <field id="repository_id" xsi:type="AttributeExternalKey">
          <sql>repository_id</sql>
          <target_class>VCSRepository</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <field id="repository_name" xsi:type="AttributeExternalField">
          <extkey_attcode>repository_id</extkey_attcode>
          <target_attcode>name</target_attcode>
        </field>
        <!-- automation -->
        <field id="automation_id" xsi:type="AttributeExternalKey">
          <sql>automation_id</sql>
          <target_class>VCSAutomation</target_class>
          <is_null_allowed>false</is_null_allowed>
          <on_target_delete>DEL_AUTO</on_target_delete>
        </field>
        <!-- automation::label -->
        <field id="automation_label" xsi:type="AttributeExternalField">
          <extkey_attcode>automation_id</extkey_attcode>
          <target_attcode>label</target_attcode>
        </field>
        <!-- status -->
        <field id="status" xsi:type="AttributeEnum">
          <values>
            <value id="active">
              <code>active</code>
              <style>
                <main_color>$ibo-lifecycle-success-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-success-state-secondary-color</complementary_color>
              </style>
            </value>
            <value id="inactive">
              <code>inactive</code>
              <style>
                <main_color>$ibo-lifecycle-frozen-state-primary-color</main_color>
                <complementary_color>$ibo-lifecycle-frozen-state-secondary-color</complementary_color>
              </style>
            </value>
          </values>
          <sql>status</sql>
          <default_value>active</default_value>
          <is_null_allowed>false</is_null_allowed>
          <display_style>list</display_style>
        </field>
        <!-- condition -->
        <field id="condition" xsi:type="AttributeString">
          <sql>condition</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods>
        <!-- IsConditionUnsetOrUnmet -->
        <method id="IsConditionUnsetOrMet">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
                public function IsConditionUnsetOrMet(array $aPayload)
                {
                    // services
		            $oTemplatingService = \Combodo\iTop\VCSManagement\Service\TemplatingService::GetInstance();

		            // check condition
                    $sCondition = $this->Get('condition');
                    if(!\utils::IsNullOrEmptyString($sCondition)){
                        $aMatch = [];
                        $res = preg_match('/([\>\w-]+)=(.*)/', $sCondition, $aMatch);
                        if($res === 1){
                            $val = $oTemplatingService->ExtractDataFromPayload($aPayload, $aPayload, $aMatch[1]);
                            if(!preg_match("#$aMatch[2]#", $val)){
                                return false;
                            }
                        }
                    }

                    return true;
                }
            ]]>
          </code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="status">
              <rank>10</rank>
            </item>
            <item id="automation_id">
              <rank>20</rank>
            </item>
            <item id="condition">
              <rank>30</rank>
            </item>
          </items>
        </details>
        <default_search>
          <items>
            <item id="status">
              <rank>10</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="status">
              <rank>10</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="status">
              <rank>10</rank>
            </item>
            <item id="condition">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* Abstract VCS Automation *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="VCSAutomation" _delta="define">
      <parent>cmdbAbstractObject</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>true</abstract>
        <key_type>autoincrement</key_type>
        <db_table>vcs_automation</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <format>%1$s</format>
          <attributes>
            <attribute id="label"/>
          </attributes>
        </naming>
        <display_template/>
        <style>
          <icon>assets/img/icons8-cloud-connection-code-fork-automation.svg</icon>
        </style>
        <reconciliation>
          <attributes>
            <attribute id="id"/>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- events -->
        <field id="events" xsi:type="AttributeEnumSet">
          <sql>events</sql>
          <values>
            <value id="create event">
              <code>create</code>
            </value>
            <value id="delete event">
              <code>delete</code>
            </value>
            <value id="push event">
              <code>push</code>
            </value>
            <value id="issue event">
              <code>issues</code>
            </value>
            <value id="pull request event">
              <code>pull_request</code>
            </value>
            <value id="milestone event">
              <code>milestone</code>
            </value>
            <value id="fork event">
              <code>fork</code>
            </value>
          </values>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- label -->
        <field id="label" xsi:type="AttributeString">
          <sql>label</sql>
          <is_null_allowed>false</is_null_allowed>
        </field>
        <!-- scope var -->
        <field id="scope_var" xsi:type="AttributeString">
          <sql>scope_var</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <!-- repositories_list -->
        <field id="repositories_list" xsi:type="AttributeLinkedSetIndirect">
          <linked_class>lnkVCSAutomationToVCSRepository</linked_class>
          <ext_key_to_me>automation_id</ext_key_to_me>
          <ext_key_to_remote>repository_id</ext_key_to_remote>
          <count_min>0</count_min>
          <count_max>0</count_max>
          <with_php_computation>true</with_php_computation>
          <duplicates/>
        </field>
      </fields>
      <methods>
        <!-- HandleEvent -->
        <method id="HandleEvent">
          <static>false</static>
          <access>public</access>
          <type>Custom</type>
          <arguments>
            <argument>event</argument>
          </arguments>
          <code>
            <![CDATA[
	            abstract public function HandleEvent($sEvent, $aPayload, $context = []);
            ]]>
          </code>
        </method>
      </methods>
      <presentation>
        <default_search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="events">
              <rank>10</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* VCS Log journal Automation *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="VCSLogJournalAutomation" _delta="define">
      <parent>VCSAutomation</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>vcs_log_journal_automation</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <format>%1$s</format>
          <attributes>
            <attribute id="label"/>
          </attributes>
        </naming>
        <display_template/>
        <reconciliation>
          <attributes>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- template -->
        <field id="template" xsi:type="AttributeLongText">
          <sql>template</sql>
          <height>300px</height>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods>
        <!-- HandleEvent -->
        <method id="HandleEvent">
          <static>false</static>
          <access>public</access>
          <type>Custom</type>
          <arguments>
            <argument>$event</argument>
          </arguments>
          <code>
            <![CDATA[

	            public function HandleEvent($sEvent, $aPayload, $context = []){

                    // parse template
                    $oTemplatingService = \Combodo\iTop\VCSManagement\Service\TemplatingService::GetInstance();
		            $sText = $oTemplatingService->ParseTemplate($this->Get('template'), $sEvent, $aPayload, $context);

                    // log parsed template
                    IssueLog::Info($sText);
	            }

            ]]>
          </code>
        </method>
        <!-- DisplayBareRelations -->
        <method id="DisplayBareRelations">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
            public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
            {
            	parent::DisplayBareRelations($oPage, $bEditMode);

            	if($bEditMode) {
            		// add css
            		$oPage->add_saas('env-' . utils::GetCurrentEnvironment() . '/combodo-github-integration/assets/css/global.scss');
            		$oPage->add(\Combodo\iTop\VCSManagement\Helper\ModuleHelper::RenderTemplate('templating_help.html.twig'));
            	}
            }
              ]]></code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="fieldset:Class:VCSLogJournalAutomation:automation">
                  <rank>10</rank>
                  <items>
                    <item id="label">
                      <rank>10</rank>
                    </item>
                    <item id="events">
                      <rank>20</rank>
                    </item>
                    <item id="scope_var">
                      <rank>30</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>20</rank>
              <items>
                <item id="fieldset:Class:VCSLogJournalAutomation:message">
                  <rank>10</rank>
                  <items>
                    <item id="template">
                      <rank>10</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="repositories_list">
              <rank>30</rank>
            </item>
          </items>
        </details>
        <default_search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>

    /* VCS Log Attribute Automation *///////////////////////////////////////////////////////////////////////////////////////////////

    <class id="VCSLogAttributeAutomation" _delta="define">
      <parent>VCSAutomation</parent>
      <properties>
        <category>bizmodel,searchable</category>
        <abstract>false</abstract>
        <key_type>autoincrement</key_type>
        <db_table>vcs_log_attribute_automation</db_table>
        <db_key_field>id</db_key_field>
        <db_final_class_field/>
        <obsolescence>
        </obsolescence>
        <naming>
          <format>%1$s</format>
          <attributes>
            <attribute id="label"/>
          </attributes>
        </naming>
        <display_template/>
        <reconciliation>
          <attributes>
          </attributes>
        </reconciliation>
      </properties>
      <fields>
        <!-- Object class -->
        <field id="object_class" xsi:type="AttributeClass">
          <sql>object_class</sql>
          <is_null_allowed>false</is_null_allowed>
          <class_category>searchable</class_category>
          <more_values>true</more_values>
        </field>
        <!-- Object Attribute -->
        <field id="object_att_code" xsi:type="AttributeClassAttCodeSet">
          <class_field>object_class</class_field>
          <sql>object_att_code</sql>
          <is_null_allowed>false</is_null_allowed>
          <dependencies>
            <attribute id="object_class"></attribute>
          </dependencies>
          <max_items>1</max_items>
          <attribute_definition_list>AttributeCaseLog,AttributeText</attribute_definition_list>
        </field>
        <!-- reference regex pattern -->
        <field id="ref_regex_pattern" xsi:type="AttributeString">
          <sql>regex</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <!-- reference regex subject data -->
        <field id="ref_regex_subject_data" xsi:type="AttributeString">
          <sql>data</sql>
          <is_null_allowed>true</is_null_allowed>
        </field>
        <!-- template -->
        <field id="template" xsi:type="AttributeText">
          <sql>template</sql>
          <height>300px</height>
          <is_null_allowed>true</is_null_allowed>
        </field>
      </fields>
      <methods>
        <!-- HandleEvent -->
        <method id="HandleEvent">
          <static>false</static>
          <access>public</access>
          <type>Custom</type>
          <arguments>
            <argument>$event</argument>
          </arguments>
          <code>
            <![CDATA[
	            public function HandleEvent($sEvent, $aPayload, $context = []){

                    // retrieve useful data
                    $sObjectClass = $this->Get('object_class');
                    $sObjectAttCode = trim($this->Get('object_att_code'));
                    $sRefRegexPattern = $this->Get('ref_regex_pattern');
                    $sRefRegexSubjectData = $this->Get('ref_regex_subject_data');

                    // get object value
                    $oAttDef = MetaModel::GetAttributeDef($sObjectClass, $sObjectAttCode);

		            $oObject = null;
                    if(!utils::IsNullOrEmptyString($sRefRegexPattern)){
                      $aMatch = [];
                      preg_match("/$sRefRegexPattern/", $aPayload[$sRefRegexSubjectData], $aMatch);
                      if(!empty($aMatch)){
                          $sOQL = "SELECT $sObjectClass WHERE ref=\"$aMatch[1]\"";
                          $oObject = MetaModel::GetObjectFromOQL($sOQL, [], true);
                      }
                    }

                    // security
                    if($oObject === null){
                        throw new Exception('HandleEvent error no object found');
                    }

                    // get value
                    $oValue = $oObject->Get($sObjectAttCode);

                    // parse template
                    $oTemplatingService = \Combodo\iTop\VCSManagement\Service\TemplatingService::GetInstance();
		            $sText = $oTemplatingService->ParseTemplate($this->Get('template'), $sEvent, $aPayload, $context);

                    // append text
                    if($oValue instanceof ormCaseLog){

                        // retrieve webhook user and log
                        $sWebhookUser = \Combodo\iTop\VCSManagement\Helper\ModuleHelper::GetModuleSetting('webhook_user_id', null);
                        if($sWebhookUser !== null){
                            $oValue->AddLogEntry($sText, '', $sWebhookUser);
                        }
                        else{
                            $oValue->AddLogEntry($sText, 'github');
                        }

                        // save
                        $oObject->Set($sObjectAttCode, $oValue);
                    }
                    else {if($oAttDef instanceof AttributeText){
                        $sep = $oAttDef->GetFormat() === 'html' ? '<br>' : '\n\r';
                        $oObject->Set($sObjectAttCode, $oValue . $sep . nl2br($sText));
                    }}

                    // update object
                    $oObject->DBUpdate();
	            }
            ]]>
          </code>
        </method>
        <!-- DisplayBareRelations -->
        <method id="DisplayBareRelations">
          <static>false</static>
          <access>public</access>
          <type>Overload-DBObject</type>
          <code><![CDATA[
            public function DisplayBareRelations(WebPage $oPage, $bEditMode = false)
            {
            	parent::DisplayBareRelations($oPage, $bEditMode);

            	if($bEditMode) {
            		// add css
            		$oPage->add_saas('env-' . utils::GetCurrentEnvironment() . '/combodo-github-integration/assets/css/global.scss');
            		$oPage->add(\Combodo\iTop\VCSManagement\Helper\ModuleHelper::RenderTemplate('templating_help.html.twig'));
            	}
            }
            ]]>
          </code>
        </method>
      </methods>
      <presentation>
        <details>
          <items>
            <item id="col:col1">
              <rank>10</rank>
              <items>
                <item id="fieldset:Class:VCSLogAttributeAutomation:automation">
                  <rank>10</rank>
                  <items>
                    <item id="label">
                      <rank>10</rank>
                    </item>
                    <item id="events">
                      <rank>20</rank>
                    </item>
                    <item id="scope_var">
                      <rank>30</rank>
                    </item>
                  </items>
                </item>
                <item id="fieldset:Class:VCSLogAttributeAutomation:target">
                  <rank>20</rank>
                  <items>
                    <item id="object_class">
                      <rank>10</rank>
                    </item>
                    <item id="object_att_code">
                      <rank>20</rank>
                    </item>
                    <item id="ref_regex_pattern">
                      <rank>30</rank>
                    </item>
                    <item id="ref_regex_subject_data">
                      <rank>40</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="col:col2">
              <rank>20</rank>
              <items>
                <item id="fieldset:Class:VCSLogAttributeAutomation:message">
                  <rank>10</rank>
                  <items>
                    <item id="template">
                      <rank>10</rank>
                    </item>
                  </items>
                </item>
              </items>
            </item>
            <item id="repositories_list">
              <rank>30</rank>
            </item>
         </items>
        </details>
        <default_search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </default_search>
        <search>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </search>
        <list>
          <items>
            <item id="label">
              <rank>10</rank>
            </item>
            <item id="events">
              <rank>20</rank>
            </item>
          </items>
        </list>
      </presentation>
    </class>
  </classes>
  <menus>
    <menu id="ConfigurationTools:VCSManagement" xsi:type="DashboardMenuNode" _delta="define">
      <rank>200</rank>
      <parent>ConfigurationTools</parent>
      <definition>
        <layout>DashboardLayoutOneCol</layout>
        <title>Menu:ConfigurationTools:VCS</title>
        <cells>
          <cell id="1">
            <rank>1</rank>
            <dashlets>
              <dashlet id="10" xsi:type="DashletHeaderStatic">
                <rank>0</rank>
                <title>Menu:VCSIntegration:General</title>
                <icon>combodo-github-integration/assets/img/icons8-code-fork.svg</icon>
              </dashlet>
              <dashlet id="11" xsi:type="DashletBadge">
                <rank>1</rank>
                <class>VCSRepository</class>
              </dashlet>
              <dashlet id="12" xsi:type="DashletBadge">
                <rank>2</rank>
                <class>VCSConnector</class>
              </dashlet>
            </dashlets>
          </cell>
          <cell id="2">
            <rank>2</rank>
            <dashlets>
              <dashlet id="20" xsi:type="DashletHeaderStatic">
                <rank>0</rank>
                <title>Menu:VCSIntegration:Automation</title>
                <icon>combodo-github-integration/assets/img/icons8-automation.svg</icon>
              </dashlet>
              <dashlet id="21" xsi:type="DashletBadge">
                <rank>1</rank>
                <class>VCSLogJournalAutomation</class>
              </dashlet>
              <dashlet id="22" xsi:type="DashletBadge">
                <rank>2</rank>
                <class>VCSLogAttributeAutomation</class>
              </dashlet>
            </dashlets>
          </cell>
        </cells>
      </definition>
    </menu>
  </menus>
  <user_rights>
    <groups>
    </groups>
    <profiles>
    </profiles>
  </user_rights>
</itop_design>
